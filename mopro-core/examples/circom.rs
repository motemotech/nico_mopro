use mopro_core::middleware::circom::CircomState;
use num_bigint::{BigInt, ToBigInt};
use std::{collections::HashMap, str::FromStr};

fn convert_strings_to_bigints(strings: &[&str]) -> Vec<BigInt> {
    strings
        .iter()
        .filter_map(|s| BigInt::from_str(s).ok())
        .collect()
}

fn main() {
    let wasm_path = "./examples/circom/verify-gov-sig/verify-gov-sig.wasm";
    let r1cs_path = "./examples/circom/verify-gov-sig/verify-gov-sig.r1cs";

    // Instantiate CircomState
    let mut circom_state = CircomState::new();

    // Setup
    let setup_res = circom_state.setup(wasm_path, r1cs_path);
    assert!(setup_res.is_ok());

    let _serialized_pk = setup_res.unwrap();

    // Deserialize the proving key and inputs if necessary

    let gov_signature:[i128; 17] = [
        1674125149413775339728388017842036472,
        501059301147402926391746946932933845,
        709558657678130579697965563482703411,
        1754033039668310015870523631387258929,
        1205965504820931622397900263388181561,
        1779747256718453402087153255842246421,
        2473123630015977814772013854711327031,
        1824964230508788832571264126977670358,
        1131811754920322521183774593931197634,
        1647429238365901243731685418895614018,
        2542404331486662988941435443914662170,
        366564126990417785631154667140992316,
        1548531078655521940857166908747739526,
        1029980503485647501063243542282919632,
        939156293304664867198374818531977824,
        461843464608224101022475437434968702,
        1433979474298383095682504852918265
    ];
    let modulus:[i128; 17] = [
        1675454107496042752634013979962232603,
        625970212480917726868048998959369009,
        480532355587819196676645575199977014,
        475719375609443376519725736080463600,
        510648938725085065786437688953030663,
        503018938135336209437826378318568820,
        2294823398553101067217702060036360169,
        832559171411134110258309349327247783,
        1371121557532908756787324522820314339,
        632914559226170399548221641333360894,
        981081598341410866872349870350360536,
        1677973536811258864550732136898935454,
        1645967954069015186850446707219392697,
        449524588890338870525940622121213120,
        1944146282771233647411537416722252685,
        2378096335112913524569702433671603210,
        3409324926358777171912406226158958
    ];
    let gov_modulus:[i128; 17] = [
        2379437293592856751278094245586663507,
        1968367197838021362623181489934596116,
        2385025815692425868228503946557175633,
        508724219255243376785785242129990415,
        489694181330895750702498621293692779,
        2028345813804719520153812030922905779,
        756350254362297505384407844341820312,
        2164451314395426632478991532364876534,
        396537459495026670368555439151417750,
        76440580931003334303166894494044779,
        1890040827750485435451581208250183034,
        1920096411284883767461769216324438751,
        700156264923519394783479247067554831,
        1998470420888620759149366909504201583,
        1024041239651791701447865202590215438,
        654907228351423399523656552874010096,
        3009361719288504065017635025443201
    ];
    // Prepare inputs
    let mut inputs = HashMap::new();
    let gov_sig = gov_signature.iter().map(
        |&s| s.to_bigint().unwrap()
    ).collect();
    inputs.insert("govSignature".to_string(), gov_sig);
    let gov_mod = gov_modulus.iter().map(
        |&s| s.to_bigint().unwrap()
    ).collect();
    inputs.insert("govModulus".to_string(), gov_mod);
    let modulus = modulus.iter().map(
        |&s| s.to_bigint().unwrap()
    ).collect();
    inputs.insert("modulus".to_string(), modulus);
    inputs.insert("userSecret".to_string(), vec![ (42).to_bigint().unwrap() ]);
    let tbsCertInDecimals = vec![ 
        48,
        130,
        6,
        46,
        48,
        130,
        5,
        22,
        160,
        3,
        2,
        1,
        2,
        2,
        4,
        6,
        191,
        195,
        65,
        48,
        13,
        6,
        9,
        42,
        134,
        72,
        134,
        247,
        13,
        1,
        1,
        11,
        5,
        0,
        48,
        129,
        130,
        49,
        11,
        48,
        9,
        6,
        3,
        85,
        4,
        6,
        19,
        2,
        74,
        80,
        49,
        13,
        48,
        11,
        6,
        3,
        85,
        4,
        10,
        12,
        4,
        74,
        80,
        75,
        73,
        49,
        37,
        48,
        35,
        6,
        3,
        85,
        4,
        11,
        12,
        28,
        74,
        80,
        75,
        73,
        32,
        102,
        111,
        114,
        32,
        117,
        115,
        101,
        114,
        32,
        97,
        117,
        116,
        104,
        101,
        110,
        116,
        105,
        99,
        97,
        116,
        105,
        111,
        110,
        49,
        61,
        48,
        59,
        6,
        3,
        85,
        4,
        11,
        12,
        52,
        74,
        97,
        112,
        97,
        110,
        32,
        65,
        103,
        101,
        110,
        99,
        121,
        32,
        102,
        111,
        114,
        32,
        76,
        111,
        99,
        97,
        108,
        32,
        65,
        117,
        116,
        104,
        111,
        114,
        105,
        116,
        121,
        32,
        73,
        110,
        102,
        111,
        114,
        109,
        97,
        116,
        105,
        111,
        110,
        32,
        83,
        121,
        115,
        116,
        101,
        109,
        115,
        48,
        30,
        23,
        13,
        50,
        51,
        48,
        53,
        49,
        57,
        49,
        54,
        51,
        55,
        48,
        57,
        90,
        23,
        13,
        50,
        55,
        49,
        50,
        48,
        55,
        49,
        52,
        53,
        57,
        53,
        57,
        90,
        48,
        47,
        49,
        11,
        48,
        9,
        6,
        3,
        85,
        4,
        6,
        19,
        2,
        74,
        80,
        49,
        32,
        48,
        30,
        6,
        3,
        85,
        4,
        3,
        12,
        23,
        52,
        49,
        50,
        53,
        57,
        52,
        69,
        55,
        53,
        74,
        65,
        67,
        74,
        77,
        49,
        52,
        49,
        48,
        52,
        48,
        48,
        51,
        65,
        48,
        130,
        1,
        34,
        48,
        13,
        6,
        9,
        42,
        134,
        72,
        134,
        247,
        13,
        1,
        1,
        1,
        5,
        0,
        3,
        130,
        1,
        15,
        0,
        48,
        130,
        1,
        10,
        2,
        130,
        1,
        1,
        0,
        168,
        23,
        186,
        248,
        250,
        78,
        110,
        118,
        8,
        104,
        209,
        219,
        197,
        110,
        229,
        0,
        153,
        210,
        42,
        103,
        173,
        152,
        50,
        135,
        19,
        249,
        253,
        242,
        5,
        93,
        155,
        115,
        252,
        108,
        217,
        166,
        192,
        235,
        156,
        162,
        79,
        247,
        192,
        227,
        74,
        210,
        104,
        191,
        139,
        126,
        171,
        150,
        242,
        112,
        1,
        127,
        50,
        115,
        152,
        19,
        208,
        7,
        197,
        44,
        151,
        99,
        34,
        188,
        50,
        0,
        73,
        179,
        230,
        139,
        154,
        25,
        83,
        220,
        145,
        90,
        117,
        162,
        232,
        93,
        126,
        250,
        32,
        5,
        212,
        242,
        243,
        204,
        58,
        188,
        162,
        52,
        241,
        26,
        228,
        237,
        216,
        254,
        125,
        127,
        96,
        243,
        202,
        49,
        170,
        244,
        221,
        197,
        32,
        225,
        227,
        201,
        37,
        238,
        145,
        253,
        8,
        17,
        131,
        22,
        180,
        187,
        155,
        145,
        12,
        236,
        116,
        248,
        120,
        164,
        227,
        80,
        44,
        43,
        13,
        137,
        64,
        100,
        234,
        92,
        155,
        121,
        92,
        68,
        12,
        211,
        238,
        125,
        225,
        218,
        161,
        11,
        49,
        158,
        245,
        96,
        169,
        104,
        40,
        161,
        250,
        76,
        28,
        23,
        243,
        35,
        145,
        243,
        52,
        236,
        104,
        23,
        185,
        83,
        171,
        174,
        134,
        37,
        142,
        251,
        234,
        226,
        181,
        178,
        139,
        206,
        99,
        172,
        8,
        164,
        128,
        114,
        220,
        246,
        53,
        105,
        63,
        180,
        175,
        126,
        127,
        192,
        122,
        211,
        162,
        183,
        129,
        114,
        48,
        76,
        24,
        218,
        185,
        243,
        210,
        6,
        88,
        28,
        72,
        73,
        184,
        216,
        241,
        29,
        109,
        181,
        239,
        212,
        46,
        44,
        137,
        100,
        113,
        158,
        166,
        150,
        99,
        66,
        174,
        67,
        230,
        255,
        16,
        27,
        153,
        74,
        232,
        69,
        174,
        71,
        207,
        27,
        2,
        3,
        1,
        0,
        1,
        163,
        130,
        2,
        252,
        48,
        130,
        2,
        248,
        48,
        14,
        6,
        3,
        85,
        29,
        15,
        1,
        1,
        255,
        4,
        4,
        3,
        2,
        7,
        128,
        48,
        19,
        6,
        3,
        85,
        29,
        37,
        4,
        12,
        48,
        10,
        6,
        8,
        43,
        6,
        1,
        5,
        5,
        7,
        3,
        2,
        48,
        73,
        6,
        3,
        85,
        29,
        32,
        1,
        1,
        255,
        4,
        63,
        48,
        61,
        48,
        59,
        6,
        11,
        42,
        131,
        8,
        140,
        155,
        85,
        8,
        5,
        1,
        3,
        30,
        48,
        44,
        48,
        42,
        6,
        8,
        43,
        6,
        1,
        5,
        5,
        7,
        2,
        1,
        22,
        30,
        104,
        116,
        116,
        112,
        58,
        47,
        47,
        119,
        119,
        119,
        46,
        106,
        112,
        107,
        105,
        46,
        103,
        111,
        46,
        106,
        112,
        47,
        99,
        112,
        115,
        46,
        104,
        116,
        109,
        108,
        48,
        129,
        183,
        6,
        3,
        85,
        29,
        18,
        4,
        129,
        175,
        48,
        129,
        172,
        164,
        129,
        169,
        48,
        129,
        166,
        49,
        11,
        48,
        9,
        6,
        3,
        85,
        4,
        6,
        19,
        2,
        74,
        80,
        49,
        39,
        48,
        37,
        6,
        3,
        85,
        4,
        10,
        12,
        30,
        229,
        133,
        172,
        231,
        154,
        132,
        229,
        128,
        139,
        228,
        186,
        186,
        232,
        170,
        141,
        232,
        168,
        188,
        227,
        130,
        181,
        227,
        131,
        188,
        227,
        131,
        147,
        227,
        130,
        185,
        49,
        57,
        48,
        55,
        6,
        3,
        85,
        4,
        11,
        12,
        48,
        229,
        133,
        172,
        231,
        154,
        132,
        229,
        128,
        139,
        228,
        186,
        186,
        232,
        170,
        141,
        232,
        168,
        188,
        227,
        130,
        181,
        227,
        131,
        188,
        227,
        131,
        147,
        227,
        130,
        185,
        229,
        136,
        169,
        231,
        148,
        168,
        232,
        128,
        133,
        232,
        168,
        188,
        230,
        152,
        142,
        231,
        148,
        168,
        49,
        51,
        48,
        49,
        6,
        3,
        85,
        4,
        11,
        12,
        42,
        229,
        156,
        176,
        230,
        150,
        185,
        229,
        133,
        172,
        229,
        133,
        177,
        229,
        155,
        163,
        228,
        189,
        147,
        230,
        131,
        133,
        229,
        160,
        177,
        227,
        130,
        183,
        227,
        130,
        185,
        227,
        131,
        134,
        227,
        131,
        160,
        230,
        169,
        159,
        230,
        167,
        139,
        48,
        129,
        187,
        6,
        3,
        85,
        29,
        31,
        4,
        129,
        179,
        48,
        129,
        176,
        48,
        129,
        173,
        160,
        129,
        170,
        160,
        129,
        167,
        164,
        129,
        164,
        48,
        129,
        161,
        49,
        11,
        48,
        9,
        6,
        3,
        85,
        4,
        6,
        19,
        2,
        74,
        80,
        49,
        13,
        48,
        11,
        6,
        3,
        85,
        4,
        10,
        12,
        4,
        74,
        80,
        75,
        73,
        49,
        37,
        48,
        35,
        6,
        3,
        85,
        4,
        11,
        12,
        28,
        74,
        80,
        75,
        73,
        32,
        102,
        111,
        114,
        32,
        117,
        115,
        101,
        114,
        32,
        97,
        117,
        116,
        104,
        101,
        110,
        116,
        105,
        99,
        97,
        116,
        105,
        111,
        110,
        49,
        32,
        48,
        30,
        6,
        3,
        85,
        4,
        11,
        12,
        23,
        67,
        82,
        76,
        32,
        68,
        105,
        115,
        116,
        114,
        105,
        98,
        117,
        116,
        105,
        111,
        110,
        32,
        80,
        111,
        105,
        110,
        116,
        115,
        49,
        21,
        48,
        19,
        6,
        3,
        85,
        4,
        11,
        12,
        12,
        75,
        97,
        110,
        97,
        103,
        97,
        119,
        97,
        45,
        107,
        101,
        110,
        49,
        35,
        48,
        33,
        6,
        3,
        85,
        4,
        3,
        12,
        26,
        89,
        111,
        107,
        111,
        104,
        97,
        109,
        97,
        45,
        115,
        104,
        105,
        45,
        78,
        97,
        107,
        97,
        45,
        107,
        117,
        32,
        67,
        82,
        76,
        68,
        80,
        48,
        58,
        6,
        8,
        43,
        6,
        1,
        5,
        5,
        7,
        1,
        1,
        4,
        46,
        48,
        44,
        48,
        42,
        6,
        8,
        43,
        6,
        1,
        5,
        5,
        7,
        48,
        1,
        134,
        30,
        104,
        116,
        116,
        112,
        58,
        47,
        47,
        111,
        99,
        115,
        112,
        97,
        117,
        116,
        104,
        110,
        111,
        114,
        109,
        46,
        106,
        112,
        107,
        105,
        46,
        103,
        111,
        46,
        106,
        112,
        48,
        129,
        178,
        6,
        3,
        85,
        29,
        35,
        4,
        129,
        170,
        48,
        129,
        167,
        128,
        20,
        140,
        213,
        88,
        106,
        137,
        20,
        133,
        229,
        89,
        55,
        155,
        126,
        41,
        212,
        16,
        207,
        210,
        139,
        53,
        147,
        161,
        129,
        136,
        164,
        129,
        133,
        48,
        129,
        130,
        49,
        11,
        48,
        9,
        6,
        3,
        85,
        4,
        6,
        19,
        2,
        74,
        80,
        49,
        13,
        48,
        11,
        6,
        3,
        85,
        4,
        10,
        12,
        4,
        74,
        80,
        75,
        73,
        49,
        37,
        48,
        35,
        6,
        3,
        85,
        4,
        11,
        12,
        28,
        74,
        80,
        75,
        73,
        32,
        102,
        111,
        114,
        32,
        117,
        115,
        101,
        114,
        32,
        97,
        117,
        116,
        104,
        101,
        110,
        116,
        105,
        99,
        97,
        116,
        105,
        111,
        110,
        49,
        61,
        48,
        59,
        6,
        3,
        85,
        4,
        11,
        12,
        52,
        74,
        97,
        112,
        97,
        110,
        32,
        65,
        103,
        101,
        110,
        99,
        121,
        32,
        102,
        111,
        114,
        32,
        76,
        111,
        99,
        97,
        108,
        32,
        65,
        117,
        116,
        104,
        111,
        114,
        105,
        116,
        121,
        32,
        73,
        110,
        102,
        111,
        114,
        109,
        97,
        116,
        105,
        111,
        110,
        32,
        83,
        121,
        115,
        116,
        101,
        109,
        115,
        130,
        4,
        1,
        51,
        195,
        73,
        48,
        29,
        6,
        3,
        85,
        29,
        14,
        4,
        22,
        4,
        20,
        202,
        120,
        97,
        35,
        205,
        197,
        135,
        152,
        193,
        130,
        253,
        222,
        62,
        202,
        5,
        226,
        177,
        130,
        21,
        165,
        48,
        13,
        6,
        9,
        42,
        134,
        72,
        134,
        247,
        13,
        1,
        1,
        11,
        5,
        0,
        3,
        130,
        1,
        1,
        0,
        70,
        179,
        93,
        147,
        240,
        72,
        109,
        19,
        42,
        255,
        87,
        214,
        79,
        249,
        44,
        121,
        82,
        7,
        75,
        31,
        38,
        187,
        93,
        192,
        186,
        3,
        119,
        205,
        63,
        45,
        55,
        254,
        188,
        22,
        178,
        38,
        164,
        101,
        146,
        52,
        239,
        105,
        202,
        152,
        24,
        203,
        190,
        180,
        101,
        221,
        225,
        84,
        148,
        138,
        196,
        120,
        70,
        11,
        218,
        18,
        163,
        199,
        160,
        227,
        122,
        206,
        26,
        93,
        130,
        192,
        130,
        175,
        15,
        24,
        98,
        52,
        200,
        13,
        244,
        255,
        50,
        102,
        37,
        244,
        74,
        184,
        252,
        70,
        105,
        231,
        166,
        152,
        216,
        120,
        210,
        111,
        83,
        134,
        21,
        185,
        178,
        204,
        187,
        132,
        106,
        122,
        145,
        16,
        166,
        2,
        140,
        77,
        233,
        196,
        152,
        137,
        229,
        78,
        64,
        132,
        217,
        250,
        160,
        186,
        121,
        181,
        169,
        126,
        130,
        96,
        43,
        85,
        198,
        188,
        194,
        175,
        188,
        215,
        122,
        159,
        207,
        247,
        148,
        90,
        81,
        32,
        75,
        118,
        190,
        107,
        119,
        19,
        154,
        46,
        150,
        254,
        248,
        95,
        11,
        14,
        55,
        108,
        213,
        234,
        77,
        234,
        216,
        138,
        16,
        98,
        62,
        27,
        184,
        234,
        188,
        226,
        152,
        52,
        221,
        226,
        174,
        132,
        43,
        10,
        48,
        57,
        151,
        108,
        187,
        251,
        166,
        215,
        130,
        23,
        67,
        154,
        142,
        132,
        11,
        180,
        248,
        167,
        118,
        197,
        180,
        110,
        140,
        16,
        61,
        129,
        138,
        34,
        159,
        197,
        112,
        178,
        0,
        33,
        46,
        10,
        206,
        237,
        93,
        14,
        24,
        204,
        193,
        0,
        67,
        1,
        1,
        0,
        93,
        188,
        111,
        235,
        231,
        183,
        128,
        9,
        171,
        66,
        108,
        190,
        23,
        214,
        132,
        2,
        168,
        171,
        124,
        139,
        170,
        236,
        30,
        248,
        256,0,0,0,0,0,0,0,0,0,0,0,0,0];
    let tbs_cert = tbsCertInDecimals.iter().map(
        |&s| s.to_bigint().unwrap()
    ).collect();
    inputs.insert("tbsCert".to_string(), tbs_cert);

    // Proof generation
    let generate_proof_res = circom_state.generate_proof(inputs);

    // Check and print the error if there is one
    if let Err(e) = &generate_proof_res {
        println!("Error: {:?}", e);
    }

    assert!(generate_proof_res.is_ok());

    let (serialized_proof, serialized_inputs) = generate_proof_res.unwrap();

    // Proof verification
    let verify_res = circom_state.verify_proof(serialized_proof, serialized_inputs);
    assert!(verify_res.is_ok());
    assert!(verify_res.unwrap()); // Verifying that the proof was indeed verified
}
